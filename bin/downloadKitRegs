#!/usr/bin/perl

use strict;
use warnings;

my $SDSC_Login_kit = <<XML;
  <Kit KitID="login.teragrid.org-5.0.0" UniqueID="capdep4.\@RESOURCE\@/login.teragrid.org-5.0.0">
    <Name>login.teragrid.org</Name>
    <Version>5.0.0</Version>
    <Description>Remote Login Capability Kit</Description>
    <Class>ctss</Class> 
    <Installed>true</Installed>
    <DefinitionURL>http://info.teragrid.org/registry/rest/capabilitydefinition-v4.teragrid.org/login.teragrid.org-5.0/</DefinitionURL>
    <DefinitionVersion>5.0.0</DefinitionVersion>
    <SupportLevel>production</SupportLevel>
    <SupportGoal>production</SupportGoal>
    <UserSupportOrganization>TeraGrid</UserSupportOrganization>
    <UserSupportContact>mailto:help\@teragrid.org</UserSupportContact>
    <StatusURL>http://inca.xsede.org/inca/HTML/kit-status-v1/login.teragrid.org-5.0.0/\@RESOURCE\@</StatusURL>
    <Software>
      <Name>gsi-openssh</Name>
      <Version>5.9p1-hpn13v11</Version>
      <Description>GSI OpenSSH (ssh) client</Description>
      <Default>yes</Default>
    </Software>
    <Software>
      <Name>modules</Name>
      <Version>3.2.9</Version>
      <Description>Modules environment management system</Description>
      <Default>yes</Default>
      <HandleType>module</HandleType>
      <HandleKey>modules</HandleKey>
    </Software>
    <Software>
      <Name>myproxy</Name>
      <Version>5.9</Version>
      <Default>yes</Default>
      <HandleType/>
      <HandleKey/>
    </Software>
    <Service>
      <Name>gsi-openssh</Name>
      <Version>5.9p1-hpn13v11</Version>
      <Description>GSI OpenSSH login service</Description>
      <Type>gsi-openssh</Type>
      <Endpoint>\@RESOURCE\@:22</Endpoint>
    </Service>
  </Kit>
XML

my $slurm = <<XML;
    <Software>
      <Name>slurm</Name>
      <Version>14.11.5</Version>
      <Description>The  Simple  Linux  Utility  for Resource Management (slurm)</Description>
      <Default>yes</Default>
      <HandleType/>
      <HandleKey/>
    </Software>
XML

my $kitRegFile = "kit-regs.xml";
my $xml = "kit-regs.xml.$$";
#`wget -o /dev/null -O $xml 'http://info.teragrid.org/web-apps/xml/reg-cat-v1/name/KitRegistration'`;
`curl 'http://info.xsede.org/web-apps/xml/reg-cat-v1/name/KitRegistration' 2>/dev/null > $xml`;
open( READ, "<$xml" );
open( WRITE, ">$kitRegFile" );
my ($resource, $kit);
while( <READ> ) {
  my $line = $_;
  ($resource) = /<ResourceID>([^<]+)<\/ResourceID>/ if /ResourceID/;
  ($kit) =  /KitID="([^"]+)"/ if /<Kit KitID/;
  if ( $line =~ /capdep4.(gordon|comet).\w+.\w+.org\/local-compute.teragrid.org-4.2.2/ ) {
    my $kitxml = $SDSC_Login_kit;
    $resource =~ s/teragrid/xsede/g;
    $kitxml =~ s/\@RESOURCE\@/$resource/g;
    print WRITE "$kitxml";
  }
  if ( $line =~ /Support(Level|Goal)/ && $resource && $resource =~ /comet/ ) {
    $line =~ s/retired/production/g;
  }
  if ( $line =~ /<Version>5.0.0<\/Version>/ && $resource && $resource =~ /comet/ && $kit && $kit =~ /core/ ) {
    $line =~ s/5.0.0/5.0.1/g;
  }
  if ( $line =~ /comet.sdsc.xsede.org\/core.teragrid.org-5.0.0/ ) {
    $line =~ s/5.0.0/5.0.1/g;
  }
  $line =~ s/SLURM/slurm/g;
  print WRITE $line;
  if ( $line =~ /<\/Extensions>/ && $resource && $resource =~ /comet/ && $kit && $kit =~ /local-compute/ ) {
    print WRITE $slurm;
  }
}
close READ;
close WRITE;
unlink $xml;
