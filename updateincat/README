Readme for updateIncat
=======================

This tool is used to make automatic updates to the XSEDE Inca deployment based
on data from XSEDE's information services.

Files:
======

xsede-config.xml = original config file that holds manually added resources and 
             custom macros as well as suites.  

xsede-config-auto.xml = current version of config file to use to generate a 
                  fresh incat-auto.xml file.

xsede-incat-auto.xml = auto=generated incat file to send to agent

Tools:
======

./bin/downloadXsedeInfo = downloads the latest software and service
                          registrations from XSEDE's information service to xsede-info.xml,
                          information about required versus optional software to componentsprequirement.xml
                        
./bin/generateXsedeConfig = generates xsede-config-auto.xml from xsede-config.xml and kit
                       definition files in etc/kits.  Should only need to be
                       run if changes are made to config.xml or etc/kits.

./bin/updateIncat = generates a fresh incat file based on input from a 
                    fresh cache file.  If used with the 'auto' argument, it
                    will reference the files indicated above.

./bin/verifyIncat = wrapper for SuiteStagesWrapper main program.  If used with
                    the 'auto' argument, will expand incat-auto.xml and place
                    the new suite files in "newsuites" and the compare them
                    against "cursuites"

General Procedures:
===================

Case 1:  changes in the cache are detected
------------------------------------------

1. Download a fresh copy of the kit registrations from info.teragrid.org

% ./bin/downloadKitRegs

2. Run updateIncat to generate new incat file incat-auto-new.xml

% ./bin/updateIncat auto

3. Verify changes and make sure agent can expand config

% ./bin/verifyIncat auto

4. Verify changes in diff.log look reasonable.  If no changes detected,
delete ~/.checkInfo file and you are done.

5. Otherwise, commit changes by commiting the diffs between incat-auto-new.xml and
incat-auto.xml 

% ./bin/commitIncat auto

This will create an incat-diff.xml file and be displayed to stdout.  Check
the incat-diff file and if it looks good, re-run with the -f option.

% ./bin/commitIncat -f auto

Press enter to continue after incat-diff is displayed.  The incat-auto-new.xml
will then be moved to incat-auto.xml and newsuites will replace the
cursuites dir.

Case 2:  changes in etc/def2config.xsl and/or config.xml are needed
-----------------------------------------------------------------

1. Make needed changes in etc/def2config.xsl and/or config.xml

2. Re-generate config-auto.xml

% ./bin/generateConfig

3. Follow steps 2 - 5 above in Case 1

4. Do svn commit on config.xml file 

Case 3:  reporter update
-----------------------------------------------------------------

1. Check in reporter to SVN

2. Go to an SDSC reference machine such as login.sdsc.edu and go to

   /misc/www/projects/inca/2.0/ctssv3/bin

3. Do a SVN update only on the changed reporter.

   % svn update <reporter name>

4. Update the repository by running

   % ./sbin/incpack -I lib/perl bin/<reporter name>

5. Force the agent to update the reporter by opening up incat and 
   clicking the "Refresh" button under the "Repositories" tab.
   Then exit incat and DO NOT commit or save changes.

6. If the reporter's list of arguments has changed, modify appropriate
   series in config.xml and then following steps in Step 2.

7. If you see email "Cron <inca@inca> ${HOME}/bin/genWebPages.pl", this is due
   to the fact we have duplicate suites in the database now.  Run the following
   on capac and nics:

   % perl deactivateExtras.pl > d.sql
   (capac) % psql tg < d.sql
   (nics) % psql xsede < d.sql

	 The consumer should update its cache within 15 minutes and the emails should
   go away.

