#!/usr/local/bin/perl

use DateTime;

my $backupdir = "/misc/inca/backups/";
my $today = DateTime->today();
my $date = $today->day_abbr();

for ($i=3; $i<= 5; $i++) {
  my $sub = $today - DateTime::Duration->new(days => $i);
  my $day = $sub->day_abbr();
  my $rm = $backupdir . $day . "-var-backup";
  `rm -rf $rm`;
  my $ulink = $backupdir . $day . "-dbbackup-teragrid.gz";
  unlink $ulink;
}

#backup up teragrid dbs
my $bin = "/misc/inca/postgresql-8.1.3/install/bin/";
my @dbnames = ("teragrid");

for my $dbname (@dbnames){
  my $dbcopy = $date . "-dbbackup-" . $dbname;
  my $dbfile = $backupdir . $dbcopy;
  unlink $dbfile;
  `touch $dbfile`;
  my $dbdump = $bin . "pg_dump -f " .  $dbfile . " " . $dbname;
  `$dbdump`;
  `gzip -f $dbfile`;
}

#backup var dir
my $var = "/misc/inca/install-2r5/var";
my $tmpvar = $backupdir . $date . "-var-backup";
`rm -rf $tmpvar`;
`mkdir $tmpvar`;
`cp -r $var/suites $tmpvar`;
`cp -r $var/repository $tmpvar`;
`cp -r $var/rm $tmpvar`;
`cp $var/*.log $tmpvar`;
`cp $var/*.xml $tmpvar`;
`gzip $tmpvar/*.log`;
