#!/usr/local/bin/perl

my $backupdir = "/misc/inca/backups/";
my $date = `date +%a`; 
chomp($date); 

my $rm = $backupdir . $date . "-var-backup";
`rm -rf $rm`;
my $ulink = $backupdir . $date . "-dbbackup-teragrid.gz";
unlink $ulink;

#backup up teragrid dbs
my $bin = "/misc/inca/postgresql-8.1.3/install/bin/";
my @dbnames = ("teragrid");

for my $dbname (@dbnames){
  my $dbcopy = $date . "-dbbackup-" . $dbname;
  my $dbfile = $backupdir . $dbcopy;
  unlink $dbfile;
  `touch $dbfile`;
  my $dbdump = $bin . "pg_dump -f " .  $dbfile . " " . $dbname;
  `$dbdump`;
  `gzip -f $dbfile`;
}

#backup var dir
my $var = "/misc/inca/install-2r5/var";
my $tmpvar = $backupdir . $date . "-var-backup";
`rm -rf $tmpvar`;
`mkdir $tmpvar`;
`cp -r $var/suites $tmpvar`;
`cp -r $var/repository $tmpvar`;
`cp -r $var/rm $tmpvar`;
`cp $var/*.log $tmpvar`;
`cp $var/*.xml $tmpvar`;
`gzip $tmpvar/*.log`;

#copy to cuzco
# commands for ssh-agent: eval `ssh-agent`; ssh-add;
my $cuzco = "cuzco.sdsc.edu:/misc/inca/backups";
`scp -r $tmpvar $cuzco; scp $ulink $cuzco`;
`scp -r $tmpvar $cuzco; "scp $dbfile.gz" $cuzco`;
`rm -rf $rm`;
unlink $ulink;
