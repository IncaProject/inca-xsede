#!/usr/bin/perl

use strict;
use warnings;

my $dir = "/home/inca/mds";
my $config = $dir."/cache";
my $xsl = $dir."/query-kit-info.xsl";
my $xml = $dir."/cache.xml.$$";
my $cache = $dir."/cache.$$";
my $new = $dir."/cache.new";
`wget -o /dev/null -O $xml 'http://info.teragrid.org/web-apps/xml/reg-cat-v1/name/KitRegistration'`;
`perl -pi -e 's/^<.xml version="1.0" encoding="UTF-8".>/<\?xml version="1.0" encoding="iso-8859-1"\?>/' $xml`;
`perl -pi -e 's/^<KitRegistration xmlns="http:\\/\\/mds.teragrid.org\\/2007\\/02\\/ctss"/<KitRegistration/' $xml`;
`export CLASSPATH=$dir/lib/saxon8.jar; /soft/java-1.5.0_16-sun/bin/java net.sf.saxon.Transform -o $cache $xml $xsl`;
my $diff = `diff $config $cache`;
if ($diff eq ""){
  unlink $cache;
  if (-e $new){unlink $new;}
}else{
  if (!-e $new){
    `echo cache | mail -s \"CACHE MDS Kit Change\" inca\@sdsc.edu`; 
  }
  `mv $cache $new`;
}
unlink $xml;
